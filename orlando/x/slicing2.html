<script type="text/javascript">

$('#slicing1').on('enterStep', function(event) {
//   if(r1) {
    
//     r1.destroy();
//     r1 = null;
//     fibers = null;
//     jQuery('#tracks').removeClass('loaded');
    
//     console.log('tracks destroyed.');
    
//   }
  
  // turn bg white
  jQuery('body').css('background-color','#fff');
  
  showSlicing1UI();
  
  console.log('Entering step #slicing1');  
}).on('leaveStep', function(event) {

  slicing1gui.destroy();
  jQuery('body').css('background-color','#000');
  
  // jQuery event triggered when leaving a specific step
  console.log('Goodbye step #slicing1!');
});

    rslicing2 = new X.renderer('rslicing2');
    rslicing2.init();
    
    // load a .NRRD file to the X.volume
    // this works with gzip/gz/raw encoded NRRD files
    var volume = new X.volume();
    volume.load('data/10mo.nrrd');
    
    rslicing2.add(volume);
    
    rslicing2.camera().setUp(0,-1,0);
    rslicing2.camera().setPosition(-80,0,200);
    rslicing2.render();
    
    function showSlicing1UI() {
      
      //
      // The GUI panel
      //
      // (we need to create this during onShowtime(..) since we do not know the volume
      // dimensions before the loading was completed)
      
      slicing1gui = new dat.GUI();
      var volumegui = slicing1gui.addFolder('Volume');
      // ,, switch between slicing and volume rendering
      var vrController = volumegui.add(volume, '_volumeRendering');
      // .. configure the volume rendering opacity
      var opacityController = volumegui.add(volume, '_opacity', 0,1);
      // .. we can threshold
      var lowerThresholdController = volumegui.add(volume, '_lowerThreshold', volume.scalarRange()[0], volume.scalarRange()[1]);
      var upperThresholdController = volumegui.add(volume, '_upperThreshold', volume.scalarRange()[0], volume.scalarRange()[1]);
      var sliceXController = volumegui.add(volume, '_indexX', 0, volume.dimensions()[0]-1);
      var sliceYController = volumegui.add(volume, '_indexY', 0, volume.dimensions()[1]-1);
      var sliceZController = volumegui.add(volume, '_indexZ', 0, volume.dimensions()[2]-1);
      volumegui.open();
      
      // volumegui callbacks
      vrController.onChange(function(value) {
        
        //document.getElementById('r').style.backgroundColor = value ? '#000000' : '#ffffff';
        if (value) {
          jQuery('body').css('background-color','#000');
        } else {
          jQuery('body').css('background-color','#fff');
        }
        
        // this setting makes the volume rendering look good
        volume.threshold(73,volume.scalarRange()[1]);
        volume.setOpacity(0.09);
        
        // Iterate over the gui controllers to grab updated values
        for (var i in volumegui.__controllers) {
          volumegui.__controllers[i].updateDisplay();
        }                
        
        volume.modified();
        rslicing2.render();
      });
      opacityController.onChange(function(value){
        volume.modified();
        rslicing2.render();
      });     
      lowerThresholdController.onChange(function(value){
        volume.modified();
        rslicing2.render();
      });
      upperThresholdController.onChange(function(value){
        volume.modified();
        rslicing2.render();
      });     
      sliceXController.onChange(function(value) {
        volume.modified();
        rslicing2.render();
      });
      sliceYController.onChange(function(value) {
        volume.modified();
        rslicing2.render();
      });          
      sliceZController.onChange(function(value) {
        volume.modified();
        rslicing2.render();
      });                                      
      
    };

</script>

<div id="rslicing2" style="background:rgba(0, 0, 0, 0); width: 100%; height: 100%;"></div>