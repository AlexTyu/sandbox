<script type="text/javascript">

$('#tracks_meshes').on('enterStep', function(event) {
  /* 
  if (r1){
    
// 	  destroy the old renderer
	  r1.destroy();
	  r1 = null;
	  tracks = null;
// 	  .. reset the loading tag for the slide
	  jQuery('#tracks').removeClass('loaded');
	  
	  console.log('tracks destroyed.');  
	  
  }
   */
  showTracksMeshesUI();
  
})
.on('leaveStep', function(event) {
  
  gui.destroy();
  
  console.log('Goodbye step #tracks_meshes!');
});

    // create a new renderer
    r2 = new X.renderer('r3');
    r2.init();
    
    // load diffusion toolkit data
    tracks2 = new X.object();
    tracks2.load('data/streamline.trk');
    
    // load a freesurfer mesh.. 
    // all freesurfer meshes have to have the extension ".fsm" to be properly recognized by XTK!
    lh = new X.object();
    lh.load('data/rh.smoothwm.fsm');
    lh.setColor(0.7,0.2,0.2);
    lh.setOpacity(0.6);
    
    // ... and another one
    rh = new X.object();
    rh.load('data/lh.smoothwm.fsm');
    rh.setColor(0,0.7,0);
    rh.setOpacity(0.6);
    
    // add the objects
    r2.add(tracks2);
    r2.add(lh);
    r2.add(rh);
    
    // .. and render it
    r2.camera().setPosition(0,0,200);
    r2.render();    
    
    r2.onShowtime = function() {

      // the following matrices were created by Dan Ginsburg
      // see http://surfer.nmr.mgh.harvard.edu/fswiki/FreeSurferTrackVisTransforms
      
      // transform the tracks
      var tracks_transform = new X.matrix(
          [[-2.00000, 0.00000, 0.00000, 110.00000],
           [0.00000, 0.00000, 2.00000, -71.00000],
           [0.00000, -2.00000, 0.00000, 110.00000],
           [0.00000, 0.00000, 0.00000, 1.00000]]); 
            
      tracks2.transform().setMatrix(tracks_transform);
      
      // transform the surfaces
      var brain_transform = new X.matrix([[9.992089867591858e-01, 2.652833424508572e-02, 2.959738858044147e-02, -1.404523849487305e+00], 
                          [-2.943054959177971e-02, -6.642243359237909e-03, 9.995449185371399e-01, -9.628264427185059e+00],
                          [-2.671264298260212e-02, 9.996254444122314e-01, 5.856084171682596e-03, -2.631434440612793e+00],
                          [0, 0, 0, 1]]);       
      
      rh.transform().setMatrix(brain_transform);
      lh.transform().setMatrix(brain_transform);
      
      // we reset the bounding box and set the world center to 0,0,0
      r2.resetBoundingBox();
            
    };
    
    console.log('tracksMeshes created.');

function showTracksMeshesUI(){
    
    
    //
    // The GUI panel
    //
    gui = new dat.GUI();
    var trackgui = gui.addFolder('Fiber Tracks');
    var trackVisibleController = trackgui.add(tracks2,'_visible');
    trackgui.open();
    
    var lhgui = gui.addFolder('Left Hemisphere');
    var lhVisibleController = lhgui.add(lh,'_visible');
    var lhOpacityController = lhgui.add(lh, '_opacity', 0, 1);
    var lhColorController = lhgui.addColor(lh, '_color');
    lhgui.open();
    
    var rhgui = gui.addFolder('Right Hemisphere');
    var rhVisibleController = rhgui.add(rh,'_visible');    
    var rhOpacityController = rhgui.add(rh, '_opacity', 0, 1);
    var rhColorController = rhgui.addColor(rh, '_color');
    rhgui.open();

    trackVisibleController.onChange(function(value) {
      r2.render();
    });      
    
    lhVisibleController.onChange(function(value) {
      r2.render();
    });      
    
    lhOpacityController.onChange(function(value) {
      r2.render();
    });    

    lhColorController.onChange(function(value) {
      r2.render();
    });        
    
    rhVisibleController.onChange(function(value) {
      r2.render();
    });      
    
    rhOpacityController.onChange(function(value) {
      r2.render();
    });            

    rhColorController.onChange(function(value) {
      r2.render();
    });     
    
}    
    
    </script>

    <div id="r3" style="background:rgba(0, 0, 0, 0); width: 100%; height: 100%;"></div>

    